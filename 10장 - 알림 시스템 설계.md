
# 10장 - 알림 시스템 설계

## 목표

사용자에게 **지속 가능하고 신뢰성 있는 비동기 알림**을 제공하는 시스템을 설계한다. 알림은 이메일, SMS, 푸시, 인앱 알림 등 다양한 채널로 전송 가능하다.

---

## 개략적 설계안

1. **서버 구성 분리**

   * 알림 처리 서버는 주 애플리케이션 서버에서 분리하여 독립적인 마이크로서비스로 운영한다.
   * 알림 전용 데이터베이스와 캐시(Redis 등)를 사용하여 부하를 분산한다.

2. **수평적 확장**

   * 알림 서버는 컨테이너화(Docker, K8s)하여 필요 시 수평 확장 가능하게 한다.

3. **비동기 처리 및 메시지 큐 활용**

   * Kafka, RabbitMQ, SQS 등을 활용하여 **알림 요청을 큐에 적재**하고, 워커가 이를 비동기 처리한다.
   * 큐는 **알림 요청의 버퍼 역할**을 하며, 서비스 간 **강한 결합을 제거**한다.

---

## 상세 설계

### 1. **안정성 확보**

* 알림 메시지는 **데이터베이스에 영속화**되어야 한다.
* 전송 실패 시 **재시도 로직**(백오프 전략 포함)을 구현한다.
* 실패 기록은 별도 테이블로 분리하고, SLA를 만족하지 못한 케이스에 대해 개발자 알림을 전송한다.

### 2. **중복 전송 방지**

* 분산 환경에서는 재시도 또는 네트워크 이슈로 인해 **동일한 알림이 여러 번 전송될 수 있다.**
* 이를 막기 위해 다음 전략을 고려한다:

  * 각 알림 요청에 **idempotency key**를 부여한다.
  * Redis에 최근 전송한 알림 해시를 캐싱하여 **중복 여부 확인 후 전송**한다.

>  **이유**: 사용자 경험 훼손(푸시 폭탄 등), 비용 증가, API rate limit 도달, 신고/차단 가능성

### 3. **알림 템플릿**

* 알림 유형(이벤트, 경고, 환영 등)별로 **템플릿 관리 시스템**을 만든다.
* 동적 파라미터 치환(`{username}`, `{item_name}`) 기능을 갖춘다.

### 4. **사용자 알림 설정**

* 사용자별로 알림 채널(푸시/SMS/이메일), 카테고리, 시간대를 선택할 수 있도록 설정 제공한다.
* **데이터모델 예시**: `UserNotificationPreference`

### 5. **전송률 제한 (Rate Limiting)**

* 사용자가 알림을 **스팸처럼 느끼지 않도록 전송 빈도를 제어**한다.

  * 예: 하루에 동일한 유형의 알림은 최대 3회
* Redis 등을 활용하여 알림 전송 시점 기록 → 전송 여부 판단

### 6. **재시도 큐 (Dead Letter Queue)**

* 전송 실패 건은 별도 \*\*DLQ(Dead Letter Queue)\*\*로 이동하여 재시도하거나, 오류 로그 분석 후 대응한다.
* 재시도 횟수 초과 시 **Slack, 이메일로 개발자에게 통보**한다.

### 7. **보안 및 인증**

* 알림 API는 내부 서비스 또는 인증된 서비스만 호출 가능하도록 **API Key**, **JWT**, **mTLS** 등을 적용한다.
* 사용자 정보를 포함한 요청은 암호화 처리 및 민감정보 보호.

### 8. **큐 모니터링**

* Kafka/Redis 큐 상태를 주기적으로 모니터링한다.
* **지표 예시**:

  * 큐 대기 중인 메시지 수
  * 평균 대기 시간
  * 처리율 및 오류율
  * 처리 지연 발생 여부

### 9. **이벤트 추적 및 분석**

* 알림이 실제로 전송되었는지, 열람되었는지, 클릭되었는지 **트래킹**한다.

  * 푸시 알림 → 클릭 여부
  * 이메일 → 오픈/클릭 트래킹
* 데이터를 기반으로 **사용자 행동 분석 및 A/B 테스트** 수행

---

## 추가 고려사항

* **다국어 지원**: 글로벌 서비스의 경우, 템플릿의 다국어 대응이 필요하다.
* **우선순위 큐**: 긴급 알림은 일반 알림보다 우선 처리되도록 한다.
* **서비스 중단 대응**: 알림 시스템 장애 시에도 장애 전파를 위한 최소한의 긴급 알림 통로 확보

---

## 마무리

알림 시스템은 단순한 "전달" 기능 이상으로 **신뢰성, 사용자 경험, 확장성, 관측성**을 고려해야 한다. 위 설계는 이러한 요구를 충족시키기 위한 **분산, 비동기, 유연한 구조**를 바탕으로 한다.


