

# 11장 - 뉴스 피드 시스템 설계

## 1단계 - 문제 이해 및 설계 범위 확정

뉴스 피드 시스템을 설계하는 목적은 면접관이 지원자의 시스템 구성 능력과 현실적인 타협, 효율적인 자원 배분, 그리고 성능 및 확장성에 대한 이해를 평가하려는 데 있다.
최소한 다음과 같은 기능은 지원해야 한다:

* 사용자의 포스팅 작성 및 발행 기능
* 친구들의 포스팅을 시간순으로 조회하는 뉴스 피드 생성 기능
* 요청 인증 및 비정상 요청에 대한 제한
* 대규모 사용자 요청에 대한 대응 방안

---

## 2단계 - 개략적 설계안 제시 및 동의 구하기

### 핵심 흐름 요약

* **피드 발행**: 사용자가 스토리를 포스팅하면 해당 데이터를 캐시 및 데이터베이스에 기록하며, 친구들의 뉴스피드에도 해당 내용을 전달한다.
* **뉴스피드 생성**: 친구들의 포스팅을 시간의 역순으로 정렬하여 사용자 뉴스피드를 생성한다.

### API 설계

#### 피드 발행 API

* **Endpoint**: `POST /v1/me/feed`
* **Request Body**: 포스팅 내용 (텍스트, 이미지 등)
* **Authorization Header**: 인증된 사용자만이 호출 가능

#### 피드 읽기 API

* **Endpoint**: `GET /v1/me/feed`
* **Authorization Header**: 인증된 사용자만 호출 가능

---

## 3단계 - 상세 설계

### 웹 서버

* 클라이언트와 통신하며 인증, 요청 제한 처리 등을 수행한다.
* 올바른 인증 토큰이 포함된 사용자만 API를 호출할 수 있어야 한다.
* 스팸이나 유해 콘텐츠를 방지하기 위해 사용자당 시간당 포스팅 수에 제한을 둔다.

---

### 포스팅 전송(팬아웃) 서비스

사용자의 새 포스팅을 친구들에게 전파하는 방식은 다음 두 가지 중 하나로 설계할 수 있다:

#### 1. **쓰기 시점 팬아웃 (Push 모델)**

* **장점**:

  * 포스팅이 실시간으로 전달되므로, 피드 조회시 빠르게 응답 가능하다.
* **단점**:

  * 친구가 많은 사용자의 포스팅이 많은 수의 친구에게 전송되면서 **핫키(Hot Key)** 문제가 발생할 수 있다.
  * 자주 사용하지 않는 친구들의 피드도 갱신되므로 자원이 낭비된다.

#### 2. **읽기 시점 팬아웃 (Pull 모델)**

* **장점**:

  * 요청 기반이므로 비활성 사용자가 많을 경우 자원을 아낄 수 있다.
  * 핫키 문제도 발생하지 않는다.
* **단점**:

  * 피드를 읽을 때 매번 친구들의 데이터를 조합해야 하므로 응답 속도가 느릴 수 있다.

→ **전략**: 대부분의 사용자에 대해서는 푸시 모델을 사용하고, 팔로워 수가 많거나 핫키 이슈가 발생할 경우 풀 모델로 전환한다.
→ **보완**: **안정 해시(consistent hashing)** 를 통해 데이터와 요청을 고르게 분산하여 핫키 문제를 완화한다.

---

### 피드 발행 흐름

1. DB에서 사용자 친구 ID 목록을 가져온다.
2. 친구 목록을 필터링하여 유효한 수신자를 추린다.
3. 친구 ID 목록과 새 포스팅 ID를 메시지 큐에 넣는다.

   * 이때, 메시지 크기를 줄이기 위해 전체 사용자 정보를 포함하지 않는다.
4. 캐시의 메모리 크기를 고려하여, 최신 포스팅 위주로 캐시하며 오래된 데이터는 캐시 미스를 허용한다.

---

### 피드 읽기 흐름

1. 이미지나 비디오 등 미디어 콘텐츠는 **CDN(Content Delivery Network)** 에 저장하여 빠르게 접근한다.
2. 클라이언트의 요청은 **로드 밸런서**를 통해 분산 처리된다.
3. 웹 서버가 **피드 서비스**를 호출하여 해당 사용자의 피드 ID 목록을 가져온다.
4. 피드 ID 목록을 바탕으로 콘텐츠를 조합하여 최종 뉴스피드를 만든다.
5. 최종적으로 JSON 형식으로 응답을 내려 클라이언트가 렌더링할 수 있도록 한다.

---

### 캐시 구조

뉴스 피드 시스템에서 **캐시 구조**는 핵심 성능 요소이다.

* **뉴스 피드 ID 목록**: 사용자의 최신 피드 항목 ID들을 보관
* **인기 콘텐츠**: 전체 시스템에서 인기 있는 포스팅을 별도 저장
* **소셜 그래프**: 친구 관계 정보를 저장
* **사용자 행동**: 좋아요, 댓글 등 활동 데이터를 저장
* **횟수 데이터**: 좋아요 수, 댓글 수, 팔로워 수 등도 캐시에 저장

---

## 4단계 - 마무리

설계 과정에서 어떤 기술을 선택했는지, 그 기술이 어떤 **트레이드오프**(타협) 하에 선택되었는지 설명할 수 있어야 한다.
시간이 남는다면 다음과 같은 **규모 확장성** 이슈에 대해서도 이야기해보자.

---

### 규모 확장성 고려사항

1. **수직적 확장 vs 수평적 확장**

   * 수직 확장: CPU, 메모리, 디스크 증설
   * 수평 확장: 서버 수를 늘려 확장

2. **SQL vs NoSQL**

   * SQL은 복잡한 쿼리에 적합하며 트랜잭션 지원이 뛰어나다.
   * NoSQL은 대규모 데이터 처리, 스키마 유연성이 장점

3. **주-부(Master-Slave) 다중화**

   * 쓰기는 Master에, 읽기는 Slave에서 처리하여 부하를 분산

4. **읽기 복제본(Read Replica)**

   * 데이터 일관성을 유지하면서 읽기 처리 성능 향상

5. **일관성 모델**

   * 강한 일관성 vs 최종 일관성 중 서비스 성격에 따라 선택

6. **데이터베이스 샤딩**

   * 데이터를 ID, 범위 또는 해시 기준으로 분할하여 저장소를 나눔


이상으로 뉴스 피드 시스템의 개략적부터 상세한 설계까지 설명하였다.
이 문서는 인터뷰 준비나 시스템 설계 스터디 자료로 사용하기에 적합하다.
